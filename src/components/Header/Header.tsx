import {Box, Button, Container, IconButton, Link, List, ListItem, Typography, useTheme} from "@mui/material";
import {NavLink} from "react-router-dom";
import React, {Dispatch, SetStateAction, useState} from "react";
import header from "./headerStyles";
import cssHeader from "./header.module.css"
import {useAppDispatch, useAppSelector} from "../../redux/hooks";
import {logout} from "../../redux/slices/userSlice";
import NotificationsIcon from '@mui/icons-material/Notifications';
import {INotificationWithUser} from "../../types/notification";
import AddBoxIcon from '@mui/icons-material/AddBox';

export function Notifications({notifications, setIsNotificationsOpen}: {
    notifications: INotificationWithUser[],
    setIsNotificationsOpen: Dispatch<SetStateAction<boolean>>
}) {

    // робити запит за сповіщеннями з полем user: true

    return (
        <Box
            sx={{
                position: 'absolute',
                top: '50px',
                left: '0px',
                transform: 'translateX(-50%)',
                bgcolor: 'background.paper',
                height: '40vh',
                width: '400px',
                overflowY: 'auto'
            }}
        >
            <List
                sx={{
                    height: '90%'
                }}
            >
                {notifications.map((notification) => {

                    const {_id: nId, type, user, receiver, checked} = notification
                    const {username, _id: userId} = user
                    // console.log(user)
                    const message = `${username} ${type === 'subscribe' ? 'subscribed on' : 'unsubscribed from'} you`

                    return (
                        <ListItem
                            key={nId}
                            onClick={(e) => {
                                // e.stopPropagation()
                                setIsNotificationsOpen(false)
                            }}
                        >
                            <NavLink style={{color: checked ? 'primary.main' : 'primary.main'}}
                                     to={`/users/${userId}`}>{message}</NavLink>
                        </ListItem>
                    )
                })}
            </List>
        </Box>
    )
}

export default function Header() {
    const theme = useTheme()

    const {palette} = theme
    const {user, isLoading, isLoggedIn, notifications} = useAppSelector((state) => state.userReducer)
    const {primaryColor, mode} = useAppSelector((state) => state.themeReducer)
    const dispatch = useAppDispatch()

    const [isNotificationsOpen, setIsNotificationsOpen] = useState(false);

    const exitFromAccount = async () => {
        await dispatch(logout())
    }

    const linkStyles = ({isActive}: { isActive: boolean }) => isActive ? header.activeLink(palette.primary.main) : header.link()

    const {username, _id: currentUserId, token = ''} = user || {}

    const unCheckedNotificationsLength = notifications?.filter(({checked}) => checked === false).length

    return (
        <Box className={cssHeader.header} sx={header.header(palette.primary.main, mode)}>
            <Container maxWidth="desktop" sx={header.container()}>
                <NavLink className={cssHeader.logo__link} to='/' style={linkStyles}>
                    <svg className={cssHeader.logo__svg}
                         width="200" height="49" viewBox="0 0 315 49" xmlns="http://www.w3.org/2000/svg">
                        <path fill={mode === 'dark' ? 'white' : 'black'} className={cssHeader.logo__path}
                              d="M0.098637 48L7.82591 1.45454H27.0532C30.538 1.45454 33.4395 2.12879 35.7577 3.47727C38.0759 4.82576 39.7198 6.71212 40.6895 9.13636C41.6592 11.5606 41.8789 14.3712 41.3486 17.5682C40.8335 20.7955 39.6744 23.6061 37.8714 26C36.0835 28.3939 33.7805 30.25 30.9623 31.5682C28.1441 32.8864 24.9395 33.5455 21.3486 33.5455H9.50773L10.985 24.6818H20.7577C22.4698 24.6818 23.9471 24.3864 25.1895 23.7955C26.4471 23.2045 27.4547 22.3788 28.2123 21.3182C28.9699 20.2576 29.4699 19.0076 29.7123 17.5682C29.9395 16.1288 29.8486 14.8864 29.4395 13.8409C29.0305 12.7803 28.2956 11.9621 27.235 11.3864C26.1895 10.8106 24.8259 10.5227 23.1441 10.5227H17.5986L11.3486 48H0.098637ZM50.2061 28.0909L46.888 48H35.7743L43.5016 1.45454H54.2516L51.297 19.5H51.6834C52.8046 17.3485 54.3652 15.6667 56.3652 14.4545C58.3652 13.2424 60.6834 12.6364 63.3198 12.6364C65.744 12.6364 67.7743 13.1818 69.4107 14.2727C71.047 15.3485 72.2061 16.8712 72.888 18.8409C73.5698 20.8106 73.691 23.1136 73.2516 25.75L69.5243 48H58.4107L61.7743 27.9318C62.0773 25.9924 61.8273 24.4773 61.0243 23.3864C60.2213 22.2955 58.9334 21.75 57.1607 21.75C55.994 21.75 54.9183 22.0076 53.9334 22.5227C52.9637 23.0227 52.1531 23.7424 51.5016 24.6818C50.8501 25.6212 50.4183 26.7576 50.2061 28.0909ZM86.5864 48.6591C82.9045 48.6591 79.8667 47.9015 77.4727 46.3864C75.0939 44.8712 73.4197 42.7576 72.45 40.0455C71.4803 37.3333 71.2909 34.1818 71.8818 30.5909C72.4727 27.0152 73.6924 23.8788 75.5409 21.1818C77.3894 18.4848 79.753 16.3864 82.6318 14.8864C85.5106 13.3864 88.7758 12.6364 92.4273 12.6364C96.0939 12.6364 99.1167 13.3939 101.495 14.9091C103.889 16.4242 105.571 18.5379 106.541 21.25C107.526 23.9621 107.723 27.1212 107.132 30.7273C106.541 34.303 105.314 37.4394 103.45 40.1364C101.586 42.8182 99.2227 44.9091 96.3591 46.4091C93.4955 47.9091 90.2379 48.6591 86.5864 48.6591ZM87.8364 40.2727C89.2 40.2727 90.4197 39.8636 91.4955 39.0455C92.5864 38.2273 93.503 37.0833 94.2455 35.6136C94.9879 34.1439 95.5182 32.4394 95.8364 30.5C96.1545 28.5909 96.1848 26.9167 95.9273 25.4773C95.6848 24.0227 95.1697 22.8939 94.3818 22.0909C93.5939 21.2727 92.5258 20.8636 91.1773 20.8636C89.8136 20.8636 88.5864 21.2803 87.4955 22.1136C86.4045 22.9318 85.4879 24.0758 84.7455 25.5455C84.0182 27 83.4955 28.7045 83.1773 30.6591C82.8591 32.5682 82.8212 34.2424 83.0636 35.6818C83.3061 37.1212 83.8288 38.25 84.6318 39.0682C85.4348 39.8712 86.503 40.2727 87.8364 40.2727ZM129.381 13.0909L127.995 21.2727H105.972L107.359 13.0909H129.381ZM113.336 4.72727H124.45L119.086 37.0227C118.98 37.7045 118.995 38.2576 119.131 38.6818C119.283 39.0909 119.556 39.3864 119.95 39.5682C120.359 39.7348 120.859 39.8182 121.45 39.8182C121.859 39.8182 122.313 39.7727 122.813 39.6818C123.313 39.5909 123.692 39.5227 123.95 39.4773L124.313 47.5C123.722 47.6667 122.927 47.8561 121.927 48.0682C120.942 48.2955 119.79 48.4394 118.472 48.5C115.806 48.6061 113.601 48.2955 111.859 47.5682C110.131 46.8258 108.912 45.6742 108.2 44.1136C107.503 42.553 107.366 40.5985 107.79 38.25L113.336 4.72727ZM139.051 48.6591C135.37 48.6591 132.332 47.9015 129.938 46.3864C127.559 44.8712 125.885 42.7576 124.915 40.0455C123.945 37.3333 123.756 34.1818 124.347 30.5909C124.938 27.0152 126.157 23.8788 128.006 21.1818C129.854 18.4848 132.218 16.3864 135.097 14.8864C137.976 13.3864 141.241 12.6364 144.892 12.6364C148.559 12.6364 151.582 13.3939 153.96 14.9091C156.354 16.4242 158.036 18.5379 159.006 21.25C159.991 23.9621 160.188 27.1212 159.597 30.7273C159.006 34.303 157.779 37.4394 155.915 40.1364C154.051 42.8182 151.688 44.9091 148.824 46.4091C145.96 47.9091 142.703 48.6591 139.051 48.6591ZM140.301 40.2727C141.665 40.2727 142.885 39.8636 143.96 39.0455C145.051 38.2273 145.968 37.0833 146.71 35.6136C147.453 34.1439 147.983 32.4394 148.301 30.5C148.62 28.5909 148.65 26.9167 148.392 25.4773C148.15 24.0227 147.635 22.8939 146.847 22.0909C146.059 21.2727 144.991 20.8636 143.642 20.8636C142.279 20.8636 141.051 21.2803 139.96 22.1136C138.87 22.9318 137.953 24.0758 137.21 25.5455C136.483 27 135.96 28.7045 135.642 30.6591C135.324 32.5682 135.286 34.2424 135.529 35.6818C135.771 37.1212 136.294 38.25 137.097 39.0682C137.9 39.8712 138.968 40.2727 140.301 40.2727ZM186.846 15.5C186.968 13.7879 186.513 12.4621 185.483 11.5227C184.468 10.5833 182.862 10.1136 180.665 10.1136C179.21 10.1136 177.968 10.303 176.937 10.6818C175.907 11.0455 175.096 11.5606 174.505 12.2273C173.915 12.8788 173.543 13.6364 173.392 14.5C173.255 15.1818 173.293 15.7879 173.505 16.3182C173.718 16.8485 174.089 17.3182 174.619 17.7273C175.165 18.1364 175.839 18.4924 176.642 18.7955C177.46 19.0985 178.377 19.3636 179.392 19.5909L183.21 20.5C185.422 21 187.339 21.6667 188.96 22.5C190.596 23.3182 191.922 24.3106 192.937 25.4773C193.952 26.6288 194.649 27.9545 195.028 29.4545C195.407 30.9545 195.437 32.6364 195.119 34.5C194.634 37.4394 193.475 39.9621 191.642 42.0682C189.824 44.1742 187.445 45.7879 184.505 46.9091C181.581 48.0303 178.18 48.5909 174.301 48.5909C170.422 48.5909 167.127 48.0076 164.415 46.8409C161.718 45.6591 159.763 43.8788 158.551 41.5C157.339 39.1212 157.013 36.1212 157.574 32.5H168.324C168.157 34 168.346 35.25 168.892 36.25C169.452 37.25 170.316 38.0076 171.483 38.5227C172.649 39.0379 174.059 39.2955 175.71 39.2955C177.225 39.2955 178.551 39.0909 179.687 38.6818C180.839 38.2727 181.755 37.7045 182.437 36.9773C183.134 36.25 183.559 35.4167 183.71 34.4773C183.862 33.6136 183.718 32.8636 183.278 32.2273C182.854 31.5909 182.127 31.0379 181.096 30.5682C180.081 30.0985 178.748 29.6742 177.096 29.2955L172.437 28.1591C168.589 27.2197 165.672 25.7197 163.687 23.6591C161.718 21.5985 161.021 18.803 161.596 15.2727C162.081 12.3788 163.278 9.84848 165.187 7.68182C167.112 5.51515 169.543 3.83333 172.483 2.63636C175.437 1.42424 178.687 0.81818 182.233 0.81818C185.839 0.81818 188.869 1.43182 191.324 2.65909C193.793 3.87121 195.574 5.58333 196.665 7.79545C197.771 9.99242 198.089 12.5606 197.619 15.5H186.846ZM206.994 28.0909L203.675 48H192.562L200.289 1.45454H211.039L208.085 19.5H208.471C209.592 17.3485 211.153 15.6667 213.153 14.4545C215.153 13.2424 217.471 12.6364 220.107 12.6364C222.532 12.6364 224.562 13.1818 226.198 14.2727C227.835 15.3485 228.994 16.8712 229.675 18.8409C230.357 20.8106 230.478 23.1136 230.039 25.75L226.312 48H215.198L218.562 27.9318C218.865 25.9924 218.615 24.4773 217.812 23.3864C217.009 22.2955 215.721 21.75 213.948 21.75C212.782 21.75 211.706 22.0076 210.721 22.5227C209.751 23.0227 208.941 23.7424 208.289 24.6818C207.638 25.6212 207.206 26.7576 206.994 28.0909ZM236.851 48.5909C234.639 48.5909 232.73 48.2197 231.124 47.4773C229.533 46.7197 228.366 45.5758 227.624 44.0455C226.897 42.5152 226.722 40.6061 227.101 38.3182C227.434 36.3788 228.048 34.75 228.942 33.4318C229.851 32.0985 230.965 31.0152 232.283 30.1818C233.616 29.3485 235.101 28.7121 236.737 28.2727C238.374 27.8333 240.086 27.5379 241.874 27.3864C243.874 27.2045 245.495 27.0076 246.737 26.7955C247.995 26.5833 248.934 26.2879 249.556 25.9091C250.177 25.5152 250.556 24.9697 250.692 24.2727V24.1591C250.874 22.9924 250.624 22.0909 249.942 21.4545C249.26 20.8182 248.237 20.5 246.874 20.5C245.419 20.5 244.177 20.8182 243.147 21.4545C242.116 22.0909 241.397 22.9697 240.987 24.0909L230.806 23.7273C231.442 21.6061 232.533 19.7121 234.078 18.0455C235.624 16.3636 237.586 15.0455 239.965 14.0909C242.359 13.1212 245.124 12.6364 248.26 12.6364C250.472 12.6364 252.472 12.9015 254.26 13.4318C256.048 13.947 257.556 14.7045 258.783 15.7045C260.025 16.6894 260.912 17.9015 261.442 19.3409C261.972 20.7803 262.086 22.4242 261.783 24.2727L257.806 48H247.351L248.169 43.1364H247.897C247.078 44.3182 246.116 45.3182 245.01 46.1364C243.919 46.9545 242.692 47.5682 241.328 47.9773C239.965 48.3864 238.472 48.5909 236.851 48.5909ZM241.533 41.3182C242.7 41.3182 243.806 41.0758 244.851 40.5909C245.897 40.1061 246.775 39.4394 247.487 38.5909C248.215 37.7273 248.677 36.7273 248.874 35.5909L249.397 32.2727C249.078 32.4394 248.677 32.5909 248.192 32.7273C247.707 32.8636 247.192 32.9924 246.647 33.1136C246.101 33.2197 245.541 33.3258 244.965 33.4318C244.404 33.5227 243.866 33.6061 243.351 33.6818C242.26 33.8485 241.313 34.1061 240.51 34.4545C239.707 34.803 239.063 35.2576 238.578 35.8182C238.109 36.3636 237.821 37.0152 237.715 37.7727C237.533 38.9091 237.798 39.7879 238.51 40.4091C239.222 41.0152 240.23 41.3182 241.533 41.3182ZM258.521 48L264.339 13.0909H275.135L274.067 19.4545H274.43C275.445 17.1515 276.771 15.4394 278.407 14.3182C280.044 13.1818 281.817 12.6136 283.726 12.6136C284.241 12.6136 284.756 12.6515 285.271 12.7273C285.801 12.7879 286.301 12.8788 286.771 13L285.135 22.6818C284.62 22.4848 283.945 22.3409 283.112 22.25C282.279 22.1439 281.521 22.0909 280.839 22.0909C279.521 22.0909 278.294 22.3864 277.157 22.9773C276.036 23.553 275.082 24.3636 274.294 25.4091C273.521 26.4394 273.014 27.6515 272.771 29.0455L269.635 48H258.521ZM293.793 48.6591C290.142 48.6591 287.112 47.9394 284.703 46.5C282.309 45.0455 280.627 42.9773 279.657 40.2955C278.687 37.5985 278.513 34.3939 279.134 30.6818C279.74 27.0758 280.975 23.9242 282.839 21.2273C284.718 18.5152 287.081 16.4091 289.93 14.9091C292.778 13.3939 295.953 12.6364 299.453 12.6364C301.937 12.6364 304.142 13.0227 306.066 13.7955C307.99 14.5682 309.581 15.7197 310.839 17.25C312.096 18.7652 312.953 20.6288 313.407 22.8409C313.862 25.053 313.846 27.5909 313.362 30.4545L312.93 33.2273H282.612L283.634 26.7727H303.634C303.816 25.5909 303.718 24.5379 303.339 23.6136C302.96 22.6894 302.346 21.9697 301.498 21.4545C300.665 20.9242 299.642 20.6591 298.43 20.6591C297.203 20.6591 296.051 20.947 294.975 21.5227C293.915 22.0833 293.013 22.8409 292.271 23.7955C291.528 24.75 291.043 25.8258 290.816 27.0227L289.612 33.6364C289.369 35.1061 289.437 36.3636 289.816 37.4091C290.195 38.4545 290.846 39.2576 291.771 39.8182C292.695 40.3636 293.884 40.6364 295.339 40.6364C296.309 40.6364 297.218 40.5076 298.066 40.25C298.915 39.9773 299.672 39.5758 300.339 39.0455C301.021 38.5 301.574 37.8409 301.998 37.0682L312.134 37.3636C311.316 39.6515 310.051 41.6439 308.339 43.3409C306.627 45.0227 304.536 46.3333 302.066 47.2727C299.612 48.197 296.854 48.6591 293.793 48.6591Z"/>
                    </svg>
                </NavLink>
                <Box sx={header.navContainer()}>
                    {
                        user && isLoggedIn ?
                            <>
                                <NavLink to='/post/create'>
                                    <IconButton color='primary'>
                                        <AddBoxIcon/>
                                    </IconButton>
                                </NavLink>
                                <Box
                                    sx={{ml: 1, position: 'relative'}}
                                >

                                    <IconButton
                                        onClick={(e) => {
                                            setIsNotificationsOpen(isOpen => !isOpen)
                                        }}
                                        className={'tabindex="0"'}
                                        onBlur={(e) => {
                                            // console.log(e)
                                            // setIsNotificationsOpen(!isNotificationsOpen)
                                        }}
                                        color='primary'
                                    >
                                        <NotificationsIcon/>
                                        {unCheckedNotificationsLength > 0 &&
                                            <Typography sx={{color: 'error.main'}}>
                                                {unCheckedNotificationsLength}
                                            </Typography>
                                        }
                                    </IconButton>
                                    {isNotificationsOpen &&
                                        <Notifications
                                            notifications={notifications}
                                            setIsNotificationsOpen={setIsNotificationsOpen}
                                        />
                                    }
                                </Box>
                                <NavLink className={cssHeader.link} style={linkStyles}
                                         to={`/users/${currentUserId}`}>{username}</NavLink>
                                <NavLink className={cssHeader.link} style={linkStyles} to='/settings'>Settings</NavLink>
                                <Button
                                    sx={{ml: 2}}
                                    variant='outlined'
                                    onClick={exitFromAccount}
                                >
                                    Exit
                                </Button>
                            </>
                            :
                            <>
                                <NavLink className={cssHeader.link} style={linkStyles} to='/login'>Login</NavLink>
                                <NavLink className={cssHeader.link} style={linkStyles} to='/register'>Register</NavLink>
                            </>
                    }
                </Box>
            </Container>
        </Box>
    )
}

